image:
  dist: alpine
  name: brave-base-alpine37-1.0
  location: local
  tar: brave-base-alpine37-1.0.tar.gz

packages:
  manager: apk
  system:
    - redis

copy:
  - source: monitrc
  - target: /etc/
  - action: |-
      chown root:root /etc/monitrc && chmod 0700 /etc/monitrc

run:
  - command: mkdir
    args:
      - /data

  - command: chown
    args:
      - -R
      - redis:redis
      - /data

  - command: sed
    args:
      - -i
    content: |-
      's#logfile /var/log/redis/redis.log#logfile ""#i' /etc/redis.conf

  - command: sed
    args:
      - -i
    content: |-
      's#daemonize yes#daemonize no#i' /etc/redis.conf

  - command: sed
    args:
      - -i
    content: |-
      's#dir /var/lib/redis/#dir /data#i' /etc/redis.conf

  - command: echo
    args:
      - -e
    content: |-
      "# placeholder for local options\n" > /etc/redis-local.conf

  - command: echo
    args:
      - -e
    content: |-
      "include /etc/redis-local.conf\n" >> /etc/redis.conf

  - command: monit
    args:
      - reload
  - command: sleep
    args:
      - 20
  - command: monit
    args:
      - restart
      - all

service:
  name: redis-alpine37
  version: 1.0
  ip: 10.0.0.20
  ports:
    - 6379:6379
  resources:
    ram: 2GB
    cpu: 1
